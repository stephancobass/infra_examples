FROM node:20-alpine AS node

# Set env vars for the build frontend

ARG REACT_APP_API_FETCH_INTERVAL
ENV REACT_APP_API_FETCH_INTERVAL=$REACT_APP_API_FETCH_INTERVAL

ARG REACT_APP_AUTH0_AUDIENCE
ENV REACT_APP_AUTH0_AUDIENCE=$REACT_APP_AUTH0_AUDIENCE

ARG REACT_APP_AUTH0_CLIENT_ID
ENV REACT_APP_AUTH0_CLIENT_ID=$REACT_APP_AUTH0_CLIENT_ID

ARG REACT_APP_AUTH0_DOMAIN
ENV REACT_APP_AUTH0_DOMAIN=$REACT_APP_AUTH0_DOMAIN

ARG REACT_APP_BE_API_KEY
ENV REACT_APP_BE_API_KEY=$REACT_APP_BE_API_KEY

ARG REACT_APP_BE_API_URL
ENV REACT_APP_BE_API_URL=$REACT_APP_BE_API_URL

COPY . .

RUN npm i 
RUN npm run build
#RUN npm run lint

FROM nginx:1.24.0-alpine

ARG BASIC_AUTH
ENV BASIC_AUTH=$BASIC_AUTH

RUN mkdir -p /app/build

COPY ./ci/mime.types ./ci/nginx.conf /etc/nginx/
RUN echo $BASIC_AUTH > /etc/nginx/.htpasswd
COPY --from=node /build/. /app/build

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]